<?php
 defined('BASEPATH') OR exit('No direct script access allowed'); class Manage extends CI_Controller{ public function __construct(){ parent::__construct(); $this->load->library('basic'); $this->basic->is_login(TRUE); $this->load->model('query','',TRUE); $this->config->load('config'); } public function images($type = 'all',$page = 0){ $this->load->helper('url'); $uri = current_url(); $data['model'] = @$this->input->get('model'); @$value = $this->input->get('value',TRUE); @$date = $this->input->get('date',TRUE); $tmp_date = explode("|",$date); $start_time = $tmp_date[0]; $end_time = $tmp_date[1]; $type = strip_tags($type); $page = (int)strip_tags($page); $limit = 16; $data['admin_title'] = '图片管理'; $sql1 = "SELECT a.id,a.imgid,a.path,a.thumb_path,a.storage,a.date,a.compression,a.level,b.mime,b.width,b.height,b.views,b.ext,b.client_name FROM img_images AS a INNER JOIN img_imginfo AS b ON a.imgid = b.imgid "; switch ($type) { case 'all': if( (isset($date)) && ($date != '') ){ $sql = $sql1."AND (Date(a.date) BETWEEN '{$start_time}' AND '{$end_time}') ORDER BY a.id DESC"; } else{ $sql = $sql1."ORDER BY a.id DESC LIMIT $limit OFFSET $page"; $num = $this->db->count_all("images"); } break; case 'admin': if( (isset($date)) && ($date != '') ){ $sql = $sql1."AND a.user = 'admin' AND (Date(a.date) BETWEEN '{$start_time}' AND '{$end_time}') ORDER BY a.id DESC"; } else{ $sql = $sql1."AND a.user = 'admin' ORDER BY a.id DESC LIMIT $limit OFFSET $page"; $num = $this->query->count_num('admin')->num; } break; case 'localhost': case 'backblaze': case 'cos': case 'qiniu': case 'ftp': if( (isset($date)) && ($date != '') ){ $sql = $sql1."AND a.storage = '{$type}' AND (Date(a.date) BETWEEN '{$start_time}' AND '{$end_time}') ORDER BY a.id DESC"; } else{ $sql = $sql1."AND a.storage = '{$type}' ORDER BY a.id DESC LIMIT $limit OFFSET $page"; $num = @$this->query->count_num($type)->num; } break; case 'visitor': if( (isset($date)) && ($date != '') ){ $sql = $sql1."AND a.user = 'visitor' AND (Date(a.date) BETWEEN '{$start_time}' AND '{$end_time}') ORDER BY a.id DESC"; } else{ $sql = $sql1."AND a.user = 'visitor' ORDER BY a.id DESC LIMIT $limit OFFSET $page"; $num = $this->query->count_num('visitor')->num; } break; case 'dubious': $sql1 = "SELECT a.ip,a.id,a.imgid,a.path,a.thumb_path,a.storage,a.date,a.compression,a.level,b.mime,b.width,b.height,b.views,b.ext,b.client_name 
                    FROM img_images AS a 
                    INNER JOIN img_imginfo AS b ON a.imgid = b.imgid "; $sql = $sql1."AND a.level = 'adult' ORDER BY a.id DESC"; break; case 'id': $value = (int)$value; if( $value === 0 ){ exit("不是有效的ID，请重新输入！"); } $sql = $sql1."AND a.id = {$value}"; break; case 'imgid': if( strlen($value) != 16){ exit("不是有效的ImgID，请重新输入！"); } $sql = $sql1."AND a.imgid = '{$value}'"; break; case 'ip': if( ! filter_var($value, FILTER_VALIDATE_IP)){ exit('不是有效的IP地址，请重新输入！'); } $sql = $sql1."AND a.ip = '{$value}'"; break; case 'name': $sql = $sql1."AND b.client_name = '{$value}'"; break; default: $sql = $sql1."AND a.user = '$type' ORDER BY a.id DESC LIMIT $limit OFFSET $page"; break; } $this->load->database(); $data['imgs'] = $this->db->query($sql)->result_array(); $this->load->library('pagination'); $config['base_url'] = "/manage/images/$type/"; $config['total_rows'] = $num; $config['per_page'] = $limit; $config['first_url'] = 0; $config['first_link'] = '首页'; $config['last_link'] = '尾页'; $config['attributes'] = array('class' => 'paging'); $config['next_link'] = '下一页'; $config['prev_link'] = '上一页'; $this->pagination->initialize($config); $data['page'] = $this->pagination->create_links(); $data['domain'] = $this->query->domain('localhost'); $data['b2_domain'] = $this->query->domain('backblaze'); $data['cos_domain'] = $this->query->domain('cos'); $data['ftp_domain'] = $this->query->domain('ftp'); $data['qiniu_domain'] = $this->query->domain('qiniu'); $data['engine'] = $this->query->list_storage(); $data['uri'] = $uri; $this->load->view('admin/header',$data); $this->load->view('admin/left'); $this->load->view('admin/images',$data); $this->load->view('admin/footer'); } public function imginfo($imgid){ $imgid = strip_tags($imgid); $row = $this->query->picinfo($imgid); $storage = $row->storage; switch ($storage) { case 'localhost': $this->load->helper('basic'); $fullpath = FCPATH.$row->path; $size = file_size($fullpath); $row->size = $size; break; case 'backblaze': case 'cos': case 'ftp': case 'qiniu': $row->size = round($row->size).'Kb'; break; default: break; } $this->load->view("admin/imginfo",$row); } public function batch_delete(){ $data['admin_title'] = '批量删除'; $this->load->view('admin/header',$data); $this->load->view('admin/left'); $this->load->view('admin/batch_delete',$data); $this->load->view('admin/footer'); } } ?>