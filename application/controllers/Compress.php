<?php
 defined('BASEPATH') OR exit('No direct script access allowed'); class Compress extends CI_Controller{ public function __construct(){ parent::__construct(); ini_set('max_execution_time','0'); } public function img($id){ $t1 = microtime(true); $this->load->model('query','',TRUE); $img = $this->query->img($id); if($img->compression == 0){ $fullpath = FCPATH.$img->path; $this->tinypng($fullpath); $this->load->model('update','',TRUE); $this->update->compress($id); $t2 = microtime(true); $used_time = round($t2 - $t1).'s'; $info = array( "code" => 200, "used_time" => $used_time, "msg" => 'compressing.' ); $info = json_encode($info); echo $info; } else{ $info = array( "code" => 0, "msg" => 'error：The image has been compressed！' ); $info = json_encode($info); echo $info; } } protected function tinypng($path){ $api_url = "https://api.tinify.com/shrink"; $data = file_get_contents($path); $ch = curl_init(); $user = "api"; $pass = "F8rNr5lh25WYcOECQvAqvcilBMAkhtIM"; curl_setopt($ch, CURLOPT_URL, $api_url); curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); curl_setopt($ch, CURLOPT_USERPWD, "{$user}:{$pass}"); curl_setopt($ch, CURLOPT_POST, 1); curl_setopt($ch, CURLOPT_POSTFIELDS, $data); curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false); curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false); $output = curl_exec($ch); curl_close($ch); $data = json_decode($output); $url = $data->output->url; $this->save($url,$path); } protected function save($url,$path){ $curl = curl_init($url); curl_setopt($curl, CURLOPT_USERAGENT, "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.110 Safari/537.36"); curl_setopt($curl, CURLOPT_FAILONERROR, true); curl_setopt($curl, CURLOPT_FOLLOWLOCATION, true); curl_setopt($curl, CURLOPT_RETURNTRANSFER, true); curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false); curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, false); $filedata = curl_exec($curl); curl_close($curl); file_put_contents($path,$filedata); } } ?>