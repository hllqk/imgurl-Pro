<?php
 class Tencent{ protected $CI; public function __construct(){ $this->CI = & get_instance(); } public function tencent_obj($method, $filename = '', $file = '',$query = '') { $app_id = $this->CI->config->item('cos')['app_id']; $accessKeyId = $this->CI->config->item('cos')['access_key_id']; $accessKeySecret = $this->CI->config->item('cos')['access_key_secret']; $bucket = $this->CI->config->item('cos')['bucket']; $domain = $this->CI->config->item('cos')['host']; $url = "http://$bucket-$app_id.$domain/$filename$query"; $signTime = time() . ';' . (time() + 3600); $options = sha1(join("\n", array( strtolower($method), "/$filename", '', "host=$bucket-$app_id.$domain", '' ))); $signOptions = join("\n", array( 'sha1', $signTime, $options, '' )); $signSecret = hash_hmac( 'sha1', $signTime, $accessKeySecret ); $hash = hash_hmac( 'sha1', $signOptions, $signSecret ); $auth = str_replace('%3B', ';', http_build_query(array( 'q-sign-algorithm' => 'sha1', 'q-ak' => $accessKeyId, 'q-sign-time' => $signTime, 'q-key-time' => $signTime, 'q-header-list' => 'host', 'q-url-param-list' => '', 'q-signature' => $hash ))); $headers = array( "Authorization: $auth" ); if ($file) { return $this->curl($url, $headers, $method, $file); } else { return $this->curl($url, $headers, $method); } } function upload ($file, $filename) { return $this->tencent_obj('PUT', $filename, $file); } function delete ($filename) { return $this->tencent_obj('DELETE', $filename); } protected function curl ($url, $headers, $method = '', $file = '', $postfileds = '') { $curl_handle = curl_init(); curl_setopt($curl_handle, CURLOPT_URL, $url); curl_setopt($curl_handle, CURLOPT_HTTPHEADER, $headers); curl_setopt($curl_handle, CURLOPT_RETURNTRANSFER, 1); if ($method) { curl_setopt($curl_handle, CURLOPT_CUSTOMREQUEST, strtoupper($method)); } if ($file) { curl_setopt($curl_handle, CURLOPT_UPLOAD, 1); $file_handle = fopen($file, 'rb'); curl_setopt($curl_handle, CURLOPT_READDATA, $file_handle); } if ($postfileds) { curl_setopt($curl_handle, CURLOPT_POSTFIELDS, $postfileds); } $response = curl_exec($curl_handle); $info = curl_getinfo($curl_handle); curl_close($curl_handle); if ($file) { fclose($file_handle); } return $response; } }