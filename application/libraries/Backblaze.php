<?php
 class Backblaze { protected $CI; protected $b2_domain; protected $b2_app_key_id; protected $b2_app_key; protected $b2_bucket_id; public function __construct($params = ''){ $this->CI = & get_instance(); $this->CI->config->load('config'); $this->CI->config->item('b2'); $params = $this->CI->config->item('b2'); $this->b2_domain = $params['b2_domain']; $this->b2_app_key_id = $params['b2_app_key_id']; $this->b2_app_key = $params['b2_app_key']; $this->b2_bucket_id = $params['b2_bucket_id']; $this->CI->load->library('session'); } public function b2_authorize_account(){ if( (!isset($_SESSION['api_url'])) OR (!isset($_SESSION['auth_token']))){ $application_key_id = $this->b2_app_key_id; $application_key = $this->b2_app_key; $credentials = base64_encode($application_key_id . ":" . $application_key); $url = "https://api.backblazeb2.com/b2api/v2/b2_authorize_account"; $session = curl_init($url); $headers = array(); $headers[] = "Accept: application/json"; $headers[] = "Authorization: Basic " . $credentials; curl_setopt($session, CURLOPT_HTTPHEADER, $headers); curl_setopt($session, CURLOPT_HTTPGET, true); curl_setopt($session, CURLOPT_SSL_VERIFYPEER, false); curl_setopt($session, CURLOPT_SSL_VERIFYHOST, false); curl_setopt($session, CURLOPT_RETURNTRANSFER, true); $server_output = curl_exec($session); curl_close ($session); $data = json_decode($server_output); $this->CI->session->set_userdata('api_url', $data->apiUrl); $this->CI->session->set_userdata('auth_token',$data->authorizationToken); } else{ return TRUE; } } public function b2_get_upload_url(){ if( (!isset($_SESSION['api_url'])) OR (!isset($_SESSION['auth_token']))){ $this->b2_authorize_account(); } if( (!isset($_SESSION['upload_url'])) OR (!isset($_SESSION['upload_auth_token']))){ $api_url = $_SESSION['api_url']; $auth_token = $_SESSION['auth_token']; $bucket_id = $this->b2_bucket_id; $session = curl_init($api_url . "/b2api/v2/b2_get_upload_url"); $data = array("bucketId" => $bucket_id); $post_fields = json_encode($data); curl_setopt($session, CURLOPT_POSTFIELDS, $post_fields); curl_setopt($session, CURLOPT_SSL_VERIFYPEER, false); curl_setopt($session, CURLOPT_SSL_VERIFYHOST, false); $headers = array(); $headers[] = "Authorization: " . $auth_token; curl_setopt($session, CURLOPT_HTTPHEADER, $headers); curl_setopt($session, CURLOPT_POST, true); curl_setopt($session, CURLOPT_RETURNTRANSFER, true); $server_output = curl_exec($session); curl_close ($session); $data = json_decode($server_output); $this->CI->session->set_userdata('upload_url', $data->uploadUrl); $this->CI->session->set_userdata('upload_auth_token',$data->authorizationToken); } else{ return TRUE; } } public function upload($localfile,$fullfile,$mime = 'text/plain'){ if( (!isset($_SESSION['upload_url'])) OR (!isset($_SESSION['upload_auth_token']))){ $this->b2_get_upload_url(); } $file_name = $fullfile; $my_file = $localfile; $handle = fopen($my_file, 'r'); $read_file = fread($handle,filesize($my_file)); $upload_url = $_SESSION['upload_url']; $upload_auth_token = $_SESSION['upload_auth_token']; $bucket_id = $this->b2_bucket_id; $content_type = $mime; $sha1_of_file_data = sha1_file($my_file); $session = curl_init($upload_url); curl_setopt($session, CURLOPT_POSTFIELDS, $read_file); curl_setopt($session, CURLOPT_SSL_VERIFYPEER, false); curl_setopt($session, CURLOPT_SSL_VERIFYHOST, false); $headers = array(); $headers[] = "Authorization: " . $upload_auth_token; $headers[] = "X-Bz-File-Name: " . $file_name; $headers[] = "Content-Type: " . $content_type; $headers[] = "X-Bz-Content-Sha1: " . $sha1_of_file_data; curl_setopt($session, CURLOPT_HTTPHEADER, $headers); curl_setopt($session, CURLOPT_POST, true); curl_setopt($session, CURLOPT_RETURNTRANSFER, true); $server_output = curl_exec($session); curl_close ($session); if(empty($server_output)){ return FALSE; } else{ try{ $data = json_decode($server_output); if($data->action == 'upload'){ return $server_output; } else{ return FALSE; } } catch(EXCeption $e){ return FALSE; } } } public function delete($file_id,$file_name){ $this->b2_authorize_account(); $api_url = $_SESSION['api_url']; $auth_token = $_SESSION['auth_token']; $file_id = $file_id; $file_name = $file_name; $session = curl_init($api_url . "/b2api/v2/b2_delete_file_version"); $data = array("fileId" => $file_id, "fileName" => $file_name); $post_fields = json_encode($data); curl_setopt($session, CURLOPT_POSTFIELDS, $post_fields); $headers = array(); $headers[] = "Authorization: " . $auth_token; curl_setopt($session, CURLOPT_HTTPHEADER, $headers); curl_setopt($session, CURLOPT_POST, true); curl_setopt($session, CURLOPT_RETURNTRANSFER, true); $server_output = curl_exec($session); curl_close ($session); if( ! empty($server_output) ){ return TRUE; } else{ return FALSE; } } }