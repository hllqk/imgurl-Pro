<?php
 class Basic{ protected $CI; public function __construct(){ $this->CI = & get_instance(); } public function is_login($type = FALSE){ @$user = $_COOKIE['user']; @$token = $_COOKIE['token']; $this->CI->load->model('query','',TRUE); $this->CI->load->helper('basic'); if($this->CI->query->userinfo()){ $userinfo = $this->CI->query->userinfo(); $userinfo = json_decode($userinfo->values); $username = $userinfo->username; $password = $userinfo->password; $password = $username.$password.get_ua(); $password = md5($password); if(($user == $username) && ($token == $password)){ return TRUE; } else{ if($type === FALSE){ return false; } else{ echo "权限不足，请<a href = '/user/login'>重新登录</a> 。"; setcookie("user", '', time()-3600,"/"); setcookie("token", '', time()-3600,"/"); exit; } } } else{ echo '数据库查询错误！'; exit; } } public function uplimit($ip){ } public function dl_pic($url){ $curl = curl_init($url); curl_setopt($curl, CURLOPT_USERAGENT, "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.110 Safari/537.36"); curl_setopt ($curl, CURLOPT_REFERER, $url); curl_setopt($curl, CURLOPT_FAILONERROR, true); curl_setopt($curl, CURLOPT_FOLLOWLOCATION, true); curl_setopt($curl, CURLOPT_RETURNTRANSFER, true); curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false); curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, false); curl_setopt($curl , CURLOPT_TIMEOUT, 60); $html = curl_exec($curl); curl_close($curl); return $html; } public function analyze(){ $data['num'] = $this->CI->db->count_all("images"); $data['month'] = $this->CI->query->count_num('month')->num; $data['day'] = $this->CI->query->count_num('day')->num; $data['admin'] = $this->CI->query->count_num('admin')->num; $data['visitor'] = $this->CI->query->count_num('visitor')->num; $data['dubious'] = $this->CI->query->count_num('dubious')->num; $data['localhost'] = $this->CI->query->count_num('localhost')->num; $data['backblaze'] = $this->CI->query->count_num('backblaze')->num; return $data; } public function conf($arg = ''){ if(is_file(FCPATH."data/json/config.js")){ $conf_path = FCPATH."data/json/config.js"; } else{ $conf_path = FCPATH."data/json/config.simple.js"; } $conf_path = str_replace("\\","/",$conf_path); $content = json_decode(file_get_contents($conf_path)); switch ($arg) { case 'alert': return $content->alert; break; case 'info': return $content->info; break; default: return $content; break; } } public function domain(){ $domain = $this->CI->query->get_domain(); return $domain; } public function get_domain($type){ switch ($type) { case 'backblaze': $this->CI->config->load('config'); $domain = $this->CI->config->item('b2')['b2_domain']; return $domain; break; case 'localhost': $domain = $this->CI->query->domain('localhost'); return $domain; break; default: $domain = $this->CI->query->get_domain(); return $domain; break; } } public function load(){ $domain = $_SERVER['SERVER_NAME']; $msg = '5oKo55qE5Z+f5ZCN5pyq57uP5o6I5p2D77yM6K+3PGEgaHJlZj0iaHR0cDovL3Nob3AuaW1ndXJsLm9yZy9vcmRlciIgdGFyZ2V0ID0gIl9ibGFuayI+6LSt5Lmw5o6I5p2DPC9hPu+8gQ=='; $msg = base64_decode($msg); $file_name = md5(base64_encode($domain)).'.txt'; $file_name = FCPATH.'data/'.$file_name; if(file_exists($file_name) ) { $tld = explode('.',$domain); $num = count($tld); $domain = $tld[$num -2].'.'.end($tld); $file_name = md5(base64_encode($domain)).'.txt'; $file_name = FCPATH.'data/'.$file_name; } $content = @file_get_contents($file_name); $this->CI->config->load('config'); $key = $this->CI->config->item('key'); $key = md5($domain.$key); $this->CI->load->library('encry'); $txt = $this->CI->encry->decrypt($content,$key); $encrypt_domain = base64_decode($txt); if(strstr($domain,$encrypt_domain) ){ exit($msg); } } public function cookie_ban(){ if( isset($_COOKIE['dubious']) && intval($_COOKIE['dubious']) >= 3 ){ $this->error_msg('您上传的违规图片过多，已被封禁！'); } return TRUE; } public function error_msg($msg){ header('Content-Type:application/json; charset=utf-8'); $data = array( "code" => 0, "msg" => $msg ); $data = json_encode($data); echo $data; exit; } } ?>